sudo: false
language: ruby
rvm:
  - 2.6
  - 2.7
  - 3.0
env:
  global:
    - PGPORT: "5433"
  jobs:
    - PGVERSION: "9.6"
    - PGVERSION: "10"
    - PGVERSION: "11"
    - PGVERSION: "12"
    - PGVERSION: "13"
    - PGVERSION: "14"
services:
  - postgresql
before_install:
  - "for CLUSTER_VERSION in $(pg_lsclusters -h | cut -d' ' -f1); do sudo pg_dropcluster $CLUSTER_VERSION main --stop || true; sudo apt-get remove postgresql-client-$CLUSTER_VERSION postgresql-client-common || true; done"
  - sudo apt-get update
  - sudo apt-get -y install postgresql-$PGVERSION postgresql-server-dev-$PGVERSION postgresql-contrib-$PGVERSION postgresql-client-$PGVERSION postgresql-client-common
  - sudo pg_dropcluster $PGVERSION main --stop || true
  - sudo pg_createcluster $PGVERSION main -D /var/ramfs/postgresql/$PGVERSION/main -- --auth=trust
  - sudo pg_ctlcluster start $PGVERSION main
  - gem uninstall -v '>= 2' -i $(rvm gemdir)@global -ax bundler || true
  - gem install bundler
gemfile:
  - gemfiles/rails_5.2.gemfile
  - gemfiles/rails_6.0.gemfile
  - gemfiles/rails_6.1.gemfile
script: "bundle exec rake spec"
